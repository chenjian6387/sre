# 04-2-钉钉报警

# 1.钉钉报警原理流程

```
和微信报警类似，发送指定的数据到钉钉官方提供的API接口，钉钉会将报警信息，发送到指定的钉钉群聊，提醒所有的群成员查看，实现告警通知。
```

![image-20220703143542464](http://book.bikongge.com/sre/2024-linux/image-20220703143542464.png)

具体操作流程

- 创建钉钉群聊
- 创建自定义机器人
- 创建报警关键词
- 生成webhook认证信息
- 开发报警脚本
- 填写zabbix-UI界面的配置
- 测试钉钉报警通知

### 

# 2.创建群聊机器人

## 1.创建群聊自定义机器人

![image-20220703145601720](http://book.bikongge.com/sre/2024-linux/image-20220703145601720.png)

## 2.设置机器人信息

![image-20220703145853874](http://book.bikongge.com/sre/2024-linux/image-20220703145853874.png)

## 3.记录webhook地址

![image-20220703145938739](http://book.bikongge.com/sre/2024-linux/image-20220703145938739.png)

```
机器人文档
https://open.dingtalk.com/document/org/application-types

用户可以向这个webhook地址发起post请求，提交数据，也就是等于给钉钉发消息了，注意字符集编码
```

## 4.测试webhook地址

```
# 提交json类的数据，发给钉钉的API
[root@m-61 /tmp]#curl 'https://oapi.dingtalk.com/robot/send?access_token=4763e2451402cce519d7599369cd545e28288b80eb6c4b58bed03a548a03d857' \
> -H 'Content-Type: application/json' \
> -d '{"msgtype": "text","text": {"content": "zabbix 报警测试，来自于www.yuchaoit.cn"}}'

# 拿到了结果
{"errcode":0,"errmsg":"ok"}
```

![image-20220703150348027](http://book.bikongge.com/sre/2024-linux/image-20220703150348027.png)

### 4.1 支持更多功能参数，如圈某人看消息

```
# 参考钉钉机器人API的文档，支持哪些参数，参考用法如下
https://open.dingtalk.com/document/robots/custom-robot-access
```

![image-20220703150729573](http://book.bikongge.com/sre/2024-linux/image-20220703150729573.png)

```
# shell发请求 ，注意json数据格式，以及zabbix触发关键字


# 圈人语法，基于手机号
curl 'https://oapi.dingtalk.com/robot/send?access_token=4763e2451402cce519d7599369cd545e28288b80eb6c4b58bed03a548a03d857' \
-H 'Content-Type: application/json' \
-d  '{"at":{"atMobiles":["15210858004"],"isAtAll":false},"text":{"content":"于超老师正在测试zabbix钉钉报警机器人！！"},"msgtype":"text"}'


# 圈人语法2，基于UserIds，员工ID，但是需要管理员查看，用户自己不好尝试了
```

![image-20220703151220573](http://book.bikongge.com/sre/2024-linux/image-20220703151220573.png)

## 5.钉钉发消息脚本

### python版

```python
#!/usr/bin/python3
# coding: utf-8
# about zabbix python script
# Author： www.yuchaoit.cn

import requests,json,sys,os,datetime
# 钉钉机器人API
webhook_url="https://oapi.dingtalk.com/robot/send?access_token=4763e2451402cce519d7599369cd545e28288b80eb6c4b58bed03a548a03d857"

# 给脚本参数手机号参数1
user_phone=sys.argv[1]

# 参数2，消息正文
text=sys.argv[2] + "\n\n" + sys.argv[3]

# 构造json数据体
data={
    "msgtype":"text",
    "text":{
        "content":text
    },
    "at":{
        "atMobiles":[user_phone],
        "isAtAll":False
    }
}

# 请求头，表明请求类型是json
headers={"Content-Type":"application/json"}

# 发HTTP请求，POST方式，传入数据与请求头
response=requests.post(url=webhook_url,data=json.dumps(data),headers=headers)
print(response.content)

# 日志目录生成
if os.path.exists("/tmp/dingding.log"):
    with open("/tmp/dingding.log","a+") as f:
        print("该文件以存在，追加写入中")
        if response.json().get("errcode")==0:
            f.write("\n" + str(datetime.datetime.now()) + "    " + str(user_phone) + "    " + "发送成功" + "\n" + str(text) )
        else:
            f.write("\n" + str(datetime.datetime.now()) + "    " + str(user_phone) + "    " + "发送失败" + "\n" + str(text) )
else:
    with open("/tmp/dingding.log","w+") as f:
        print("该日志文件不存在，创建且写入中")
        if response.json().get("errcode")==0:
            f.write("\n" + str(datetime.datetime.now()) + "    " + str(user_phone) + "    " + "发送成功" + "\n" + str(text) )
        else:
            f.write("\n" + str(datetime.datetime.now()) + "    " + str(user_phone) + "    " + "发送失败" + "\n" + str(text) )
```

执行结果

```
[root@m-61 /tmp]#python3 ding.py 15210858004 "python测试钉钉机器人" "zabbix故障了！！抓紧起来修复啊超哥！！火星撞地球了！！"
b'{"errcode":0,"errmsg":"ok"}'
该文件以存在，追加写入中
[root@m-61 /tmp]#
[root@m-61 /tmp]#
[root@m-61 /tmp]#
```

代码执行结果

![image-20220703154754844](http://book.bikongge.com/sre/2024-linux/image-20220703154754844.png)

------

钉钉结果

![image-20220703154823426](http://book.bikongge.com/sre/2024-linux/image-20220703154823426.png)

### bash版

```bash
#!/bin/bash
# about zabbix bash script
# Author： www.yuchaoit.cn


#webhook 地址 webhook=''
#接受者的手机号，由 zabbix 传入 
user=$1
#报警邮件标题，由 zabbix 传入 
title=$2
#报警邮件内容，由 zabbix 传入
message=$3

# 构造语句执行发送动作
# bash就是用curl 构造json数据发出去而已，注意引号的细节就好
# 通过API返回的数据，来确认是否发送正确

curl -s -H "Content-Type: application/json" -X POST "https://oapi.dingtalk.com/robot/send?access_token=4763e2451402cce519d7599369cd545e28288b80eb6c4b58bed03a548a03d857" -d '{"msgtype":"text","text":{"content":"'"${title}\n\n${message}\n\nzabbix报警啦"'"},"at":{"atMobiles":["'"${user}"'"],"isAtAll":false}}' 


#将报警信息写入日志文件
echo -e "\n 报警时间:$(date +%F-%H:%M)\n 报警标题:${title}\n 报警内容:${message}" >> /tmp/ding_bash.log
```

测试运行

```
[root@m-61 /tmp]#bash b.sh 15210858004 zabbix报警啦 "zabbix报警啦，火星撞地球啦 超哥。。。bash脚本也可以啦"
{"errcode":0,"errmsg":"ok"}[root@m-61 /tmp]#
[root@m-61 /tmp]#
[root@m-61 /tmp]#bash b.sh 15210858004 zabbix报警啦 "zabbix报警啦，火星撞地球啦 超哥。。。bash脚本也可以啦"
{"errcode":0,"errmsg":"ok"}[root@m-61 /tmp]#
```

![image-20220703161355470](http://book.bikongge.com/sre/2024-linux/image-20220703161355470.png)

钉钉结果

![image-20220703161558231](http://book.bikongge.com/sre/2024-linux/image-20220703161558231.png)

# 3.zabbix-UI页面配置钉钉报警

脚本调通后，就可以去zabbix的UI页面配置参数，提供报警

```
思路依然是
创建报警媒介类型
↓
创建媒体类型
↓
钉钉报警创建
↓
用户选择报警媒介方式
```

## 创建媒体类型

![image-20220703161856836](http://book.bikongge.com/sre/2024-linux/image-20220703161856836.png)

注意坑

```
1.脚本放入zabbix目录，采用python脚本，闲的更nb
2.脚本权限
[root@m-61 /usr/lib/zabbix/alertscripts]#chmod +x dingding.py 
[root@m-61 /usr/lib/zabbix/alertscripts]#ls
dingding.py  weixin.sh  weixin_zabbix.py


3.日志文件权限
[root@m-61 /tmp]#rm -rf /tmp/*.log
```

![image-20220703162209005](http://book.bikongge.com/sre/2024-linux/image-20220703162209005.png)

## 用户选择报警媒介（钉钉）

![image-20220703162315760](http://book.bikongge.com/sre/2024-linux/image-20220703162315760.png)

## 实测zabbix钉钉报警结果

## 坑记录，最后一步zabbix调用python发报警，别忘记关键字

给zabbix中的动作，添加关键字即可，否则无法触发钉钉机器人

```
Author: www.yuchaoit.cn
keyword: zabbix
告警主机:{HOSTNAME1} {HOST.IP}
告警时间:{EVENT.DATE} {EVENT.TIME}
告警等级:{TRIGGER.SEVERITY}
告警信息: {TRIGGER.NAME}
告警项目:{TRIGGER.KEY1}
问题详情:{ITEM.NAME}:{ITEM.VALUE}
当前状态:{TRIGGER.STATUS}:{ITEM.VALUE1}
事件ID:{EVENT.ID}　　


-------
Author: www.yuchaoit.cn
keyword: zabbix
告警主机:{HOSTNAME1} {HOST.IP}
告警时间:{EVENT.DATE} {EVENT.TIME}
告警等级:{TRIGGER.SEVERITY}
告警信息: {TRIGGER.NAME}
告警项目:{TRIGGER.KEY1}
问题详情:{ITEM.NAME}:{ITEM.VALUE}
当前状态:{TRIGGER.STATUS}:{ITEM.VALUE1}
事件ID:{EVENT.ID}
```

![image-20220703165408872](http://book.bikongge.com/sre/2024-linux/image-20220703165408872.png)

## 完结下班！！

![image-20220703165712008](http://book.bikongge.com/sre/2024-linux/image-20220703165712008.png)

\--

![image-20220703165747859](http://book.bikongge.com/sre/2024-linux/image-20220703165747859.png)