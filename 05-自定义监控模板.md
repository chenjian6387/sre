# 05-自定义监控模板

# 1.自定义模板需求

```
目前我们已学习了

1. zabbix监控服务器（使用模板，啥也不用操心，拿来即用）
2. 自定义监控项、触发器（自己的一些额外需求，使用zabbix监控）
3. 自定义报警方式（丰富的邮件、微信、钉钉报警）不怕收不到消息

新的需求来了，工作里，不能只有一台机器监控，很多台机器都要监控，咋办
因此将需要重复的监控项、整理为模板，同一服务类型的主机可以使用模板，完成统一的监控任务。
```

# 2.自定义模板实践

```
将之前配置的TCP状态监控项、触发器，抽象为模板，和新主机管理
```

## 2.1 创建新模板

![image-20220703192248803](/ajian/image-20220703192248803.png)

## 2.2 新模板详细信息

![image-20220703192629760](/ajian/image-20220703192629760.png)

## 2.3 添加监控项

当前模板内容是空，添加即可

![image-20220703192730668](/ajian/image-20220703192730668.png)

创建自定义监控项详细，和自定义监控项章节一样

![image-20220703203248686](/ajian/image-20220703203248686.png)

模板里可以包括很多个监控项，因此重复前面的步骤，创建其他11个TCP连接状态的监控项。

![image-20220703204057071](/ajian/image-20220703204057071.png)

## 2.4 创建触发器

监控的内容有了，什么条件触发监控？

触发器来了

![image-20220703204438100](/ajian/image-20220703204438100.png)

创建其他TCP状态的触发器即可

![image-20220703204634606](/ajian/image-20220703204634606.png)

## 2.5 关联主机（web-8）

再加一个web8机器监控，然后关联模板

```
# 1.目标机器安装zabbix-agent 
rpm -ivh https://mirrors.tuna.tsinghua.edu.cn/zabbix/zabbix/4.0/rhel/7/x86_64/zabbix-agent-4.0.11-1.el7.x86_64.rpm

# 友情提醒，先做好时间同步！！
ntpdate -u ntp.aliyun.com


修改配置如下，保证和我一样先
cat >/etc/zabbix/zabbix_agentd.conf <<'EOF'
PidFile=/var/run/zabbix/zabbix_agentd.pid 
LogFile=/var/log/zabbix/zabbix_agentd.log
LogFileSize=0
Server=10.0.0.61
Include=/etc/zabbix/zabbix_agentd.d/*.conf
EOF

3.启动agent
systemctl start zabbix-agent && systemctl enable zabbix-agent



4.检查,agent的端口是10050
netstat -tunlp|grep zabbix
```

![image-20220703205623527](/ajian/image-20220703205623527.png)

------

![image-20220703205845965](/ajian/image-20220703205845965.png)

------

## 2.6 添加自定义key配置文件(web-8)

```
[root@web-8 ~]#cat /etc/zabbix/zabbix_agentd.d/tcp_status.conf 
UserParameter=tcp_status[*],netstat -ant|grep -c $1

[root@web-8 ~]#systemctl restart zabbix-agent

装个nginx测测tcp
[root@web-8 ~]#yum install nginx -y
[root@web-8 ~]#systemctl start nginx
```

![image-20220703210216052](/ajian/image-20220703210216052.png)

## 2.7 查看web8关联模板后的最新数据

![image-20220703210726410](/ajian/image-20220703210726410.png)

## 2.8 给模板添加图形

目前咱还没加图形

![image-20220703210812979](/ajian/image-20220703210812979.png)

------

![image-20220703210854933](/ajian/image-20220703210854933.png)

## 2.9 检查web8关联了图形

![image-20220703211004965](/ajian/image-20220703211004965.png)

```
web8机器TCP过多，触发器执行，也同样会发报警动作，发邮件、微信、钉钉等。
```

## 3.0 导出、导入模板

导出模板

![image-20220703211625928](/ajian/image-20220703211625928.png)

导入模板

```
systemctl restart httpd zabbix-server
重启后方可导入
```

![image-20220703212731515](/ajian/image-20220703212731515.png)

# 3.聚合图形

![image-20220703213759785](/ajian/image-20220703213759785.png)
